name: Java API CI/CD Pipeline

on: # Definindo os eventos que disparam o workflow
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions: # Definindo permissões mínimas necessárias para o workflow
  contents: read
  id-token: write

env: # Definindo variáveis de ambiente para uso no workflow
  ARTIFACT_NAME: "java-api-artifact" # NOME PADRONIZADO PARA UPLOAD E DOWNLOAD
  IMAGE_NAME: "java-api:${{ github.sha }}"
  REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}
  REGISTRY_IMAGE: "${{ secrets.AZURE_REGISTRY_NAME }}/java-api:${{ github.sha }}"

jobs: # Definindo o job principal do workflow
  build-and-test: # Nome do job
    runs-on: ubuntu-latest

    steps: # Definindo os passos do job
      - name: Checkout code # Passo para fazer checkout do código-fonte
        uses: actions/checkout@v3

      - name: Setup JAVA # Passo para configurar o ambiente Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven # Passo para construir o projeto usando Maven
        run: mvn clean package

      - name: Run tests # Passo para executar os testes unitários
        run: mvn test
      
      - name: Build Docker image # Passo para construir a imagem Docker
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: Trivy Scan # Passo para escanear a imagem Docker em busca de vulnerabilidades
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH
      
      # CORREÇÃO: Usando azure/login para autenticar o AZ CLI
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      # CORREÇÃO: Usando o AZ CLI para login no ACR (substitui o acr-helper que falhou)
      - name: Docker Login to ACR via CLI
        run: az acr login --name ${{ env.REGISTRY_NAME }}
      
      - name: Tag and Push Docker image to ACR # Passo para marcar e enviar a imagem Docker para o ACR
        run: |
          docker tag ${{ env.IMAGE_NAME }} ${{ env.REGISTRY_IMAGE }}
          docker push ${{ env.REGISTRY_IMAGE }}

      # CORREÇÃO DE ARTEFATO: Usando ARTIFACT_NAME do ENV e definindo PATH
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }} # Usa o nome padronizado (java-api-artifact)
          path: target/*.jar              # Onde o Maven salva o JAR
          retention-days: 1
      
  # CORREÇÃO ESTRUTURAL: Este é um novo Job, alinhado com 'build-and-test'
  deploy-staging:
    needs: build-and-test
    runs-on: ubuntu-latest
    
    steps:
      # CORREÇÃO DE ARTEFATO: Usa o mesmo nome de variável definido no ENV
      - name: Download Jar
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }} # Usa o nome padronizado (java-api-artifact)
          
      - name: Fake Deploy to Staging # Passo para simular o deploy para o ambiente de staging
        run: |
          echo "Artifact ${{ env.ARTIFACT_NAME }} downloaded successfully."
          echo "Fake deploy to Staging environment"