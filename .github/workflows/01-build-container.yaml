name: Java API CI/CD Pipeline

on: # Definindo os eventos que disparam o workflow
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions: # Definindo permissões mínimas necessárias para o workflow
  contents: read
  id-token: write

env: # Definindo variáveis de ambiente para uso no workflow
  ARTIFACT_NAME: "api-${{ github.sha }}.jar"
  IMAGE_NAME: "java-api:${{ github.sha }}"
  REGISTRY_NAME: ${{ secrets.AZURE_REGISTRY_NAME }}
  REGISTRY_IMAGE: "${{ secrets.AZURE_REGISTRY_NAME }}/java-api:${{ github.sha }}"

jobs: # Definindo o job principal do workflow
  build-and-test: # Nome do job
    runs-on: ubuntu-latest

    steps: # Definindo os passos do job
      - name: Checkout code # Passo para fazer checkout do código-fonte
        uses: actions/checkout@v3

      - name: Setup JAVA # Passo para configurar o ambiente Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build with Maven # Passo para construir o projeto usando Maven
        run: mvn clean package

      - name: Run tests # Passo para executar os testes unitários
        run: mvn test
      
      - name: Build Docker image # Passo para construir a imagem Docker
        run: docker build -t ${{ env.IMAGE_NAME }} .

      - name: Trivy Scan # Passo para escanear a imagem Docker em busca de vulnerabilidades
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.IMAGE_NAME }}
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH
      
      - name: Azure Login # Passo para autenticar no Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Docker Login to ACR via CLI
        run: az acr login --name ${{ env.REGISTRY_NAME }}
      
      - name: Tag and Push Docker image to ACR # Passo para marcar e enviar a imagem Docker para o ACR
        run: |
          docker tag ${{ env.IMAGE_NAME }} ${{ env.REGISTRY_IMAGE }}
          docker push ${{ env.REGISTRY_IMAGE }}

      - name: Archive artifact # Passo para arquivar o artefato gerado
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_NAME }}
      
  deploy-staging: # Definindo o job de deploy para o ambiente de staging
      needs: build-and-test
      runs-on: ubuntu-latest
      steps:
        - name: Download Jar # Passo para baixar o artefato gerado
          uses: actions/download-artifact@v4
          with:
            name: java-api-artifact

        - name: Fake Deploy to Staging # Passo para simular o deploy para o ambiente de staging
          run: |
            echo "Build and Test: ${{ env.ARTIFACT_NAME}}"
            echo "Fake deploy to Staging environment"